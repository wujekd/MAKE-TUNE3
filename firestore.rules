rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() { 
      return isSignedIn() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; 
    }
    function isOwner(project) { return isSignedIn() && project.data.ownerId == request.auth.uid; }
    function isCollabOwner(collabId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/collaborations/$(collabId))
        && get(/databases/$(database)/documents/collaborations/$(collabId)).data.projectId is string
        && exists(/databases/$(database)/documents/projects/$(get(/databases/$(database)/documents/collaborations/$(collabId)).data.projectId))
        && get(/databases/$(database)/documents/projects/$(get(/databases/$(database)/documents/collaborations/$(collabId)).data.projectId)).data.ownerId == request.auth.uid;
    }
    function validateProjectData(data) {
      return data.name is string && data.name.size() >= 3 && data.name.size() <= 100
        && data.description is string && data.description.size() <= 500
        && data.ownerId is string
        && data.isActive is bool
        && data.pastCollaborations is list
        && data.createdAt is timestamp
        && data.updatedAt is timestamp
        && (!('tags' in data) || (data.tags is list && data.tags.size() <= 10))
        && (!('tagsKey' in data) || (data.tagsKey is list && data.tagsKey.size() <= 10))
        && (!('currentCollaborationId' in data) || data.currentCollaborationId == null || data.currentCollaborationId is string)
        && (!('currentCollaborationStatus' in data) || data.currentCollaborationStatus == null || data.currentCollaborationStatus is string)
        && (!('currentCollaborationStageEndsAt' in data) || data.currentCollaborationStageEndsAt == null || data.currentCollaborationStageEndsAt is timestamp)
        && (!('nameKey' in data) || data.nameKey is string);
    }

    function validateCollaborationData(data) {
      let validStatuses = ['draft', 'published', 'submission', 'voting', 'completed', 'unpublished'];
      return data.keys().hasAll(['projectId', 'name', 'status', 'createdAt', 'updatedAt'])
        && data.projectId is string
        && data.name is string && data.name.size() >= 3 && data.name.size() <= 100
        && data.status is string && data.status in validStatuses
        && data.createdAt is timestamp
        && data.updatedAt is timestamp
        && (!('participantIds' in data) || data.participantIds is list)
        && (!('submissions' in data) || data.submissions is list)
        && (!('submissionPaths' in data) || data.submissionPaths is list)
        && (!('publishedAt' in data) || data.publishedAt == null || data.publishedAt is timestamp)
        && (!('backingTrackPath' in data) || data.backingTrackPath is string)
        && (!('description' in data) || data.description is string)
        && (!('submissionDuration' in data) || data.submissionDuration is number)
        && (!('votingDuration' in data) || data.votingDuration is number)
        && (!('requiresModeration' in data) || data.requiresModeration is bool)
        && (!('submissionCloseAt' in data) || data.submissionCloseAt is timestamp)
        && (!('votingCloseAt' in data) || data.votingCloseAt is timestamp)
        && (!('winnerPath' in data) || data.winnerPath is string)
        && (!('tags' in data) || (data.tags is list && data.tags.size() <= 10))
        && (!('tagsKey' in data) || (data.tagsKey is list && data.tagsKey.size() <= 10))
        && (!('pdfPath' in data) || data.pdfPath is string)
        && (!('resourcesZipPath' in data) || data.resourcesZipPath is string)
        && (!('submissionsCount' in data) || data.submissionsCount is number)
        && (!('reservedSubmissionsCount' in data) || data.reservedSubmissionsCount is number)
        && (!('favoritesCount' in data) || data.favoritesCount is number)
        && (!('votesCount' in data) || data.votesCount is number)
        && (!('submissionLimitOverride' in data) || data.submissionLimitOverride is number);
    }

    function validateCollaborationDetailData(data) {
      return (!('collaborationId' in data) || data.collaborationId is string)
        && (!('submissions' in data) || data.submissions is list)
        && (!('submissionPaths' in data) || data.submissionPaths is list)
        && (!('createdAt' in data) || data.createdAt is timestamp)
        && (!('updatedAt' in data) || data.updatedAt is timestamp);
    }


    match /projects/{projectId} {
      allow read: if true;
      // Project creation is server-only (createProjectWithUniqueName CF).
      allow create: if false;
      allow update: if isOwner(resource)
        && validateProjectData(request.resource.data)
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isOwner(resource);
    }

    match /collaborations/{collabId} {
      allow read: if (resource.data.status != 'unpublished')
        || isCollabOwner(collabId)
        || isAdmin();

      allow create: if isSignedIn()
        && exists(/databases/$(database)/documents/projects/$(request.resource.data.projectId))
        && get(/databases/$(database)/documents/projects/$(request.resource.data.projectId)).data.ownerId == request.auth.uid
        && validateCollaborationData(request.resource.data)
        && (!('submissionLimitOverride' in request.resource.data))
        && (!('reservedSubmissionsCount' in request.resource.data) || request.resource.data.reservedSubmissionsCount == 0)
        && (!('submissionsCount' in request.resource.data) || request.resource.data.submissionsCount == 0);

      allow update: if get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.ownerId == request.auth.uid
        && validateCollaborationData(request.resource.data)
        && request.resource.data.projectId == resource.data.projectId
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.get('submissionsCount', 0) == resource.data.get('submissionsCount', 0)
        && request.resource.data.get('reservedSubmissionsCount', 0) == resource.data.get('reservedSubmissionsCount', 0)
        && request.resource.data.get('participantIds', []) == resource.data.get('participantIds', [])
        && request.resource.data.get('submissionLimitOverride', null) == resource.data.get('submissionLimitOverride', null)
        && request.resource.data.get('unmoderatedSubmissions', false) == resource.data.get('unmoderatedSubmissions', false);

      allow delete: if get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.ownerId == request.auth.uid;
    }

    match /collaborationDetails/{collabId} {
      allow read: if isAdmin() || isCollabOwner(collabId);
      allow create: if isSignedIn()
        && validateCollaborationDetailData(request.resource.data)
        && request.resource.data.collaborationId == collabId
        && request.resource.data.submissions is list
        && request.resource.data.submissions.size() == 0
        && (!('submissionPaths' in request.resource.data) || request.resource.data.submissionPaths.size() == 0)
        && exists(/databases/$(database)/documents/collaborations/$(collabId))
        && (
          get(/databases/$(database)/documents/projects/$(get(/databases/$(database)/documents/collaborations/$(collabId)).data.projectId)).data.ownerId == request.auth.uid
        );
      allow update: if false;
    }

    function isUserSelf(userId) { return isSignedIn() && request.auth.uid == userId; }
    function userChangedKeys() {
      return request.resource.data.diff(resource.data).affectedKeys();
    }
    function usernameClaimedByUser(userId) {
      return request.resource.data.username is string
        && exists(/databases/$(database)/documents/usernames/$(request.resource.data.username))
        && get(/databases/$(database)/documents/usernames/$(request.resource.data.username)).data.uid == userId;
    }
    function usernameClaimedByUserAfter(userId) {
      return request.resource.data.username is string
        && existsAfter(/databases/$(database)/documents/usernames/$(request.resource.data.username))
        && getAfter(/databases/$(database)/documents/usernames/$(request.resource.data.username)).data.uid == userId;
    }
    function isValidUserCreate(userId) {
      return request.resource.data.keys().hasOnly(['uid', 'email', 'createdAt', 'collaborationIds', 'username'])
        && request.resource.data.uid == userId
        && request.resource.data.email is string
        && request.resource.data.createdAt is timestamp
        && request.resource.data.collaborationIds is list
        && (
          !('username' in request.resource.data)
          || usernameClaimedByUser(userId)
        );
    }
    function isValidUserSelfUpdate(userId) {
      return userChangedKeys().hasOnly(['collaborationIds', 'username'])
        && request.resource.data.uid == userId
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.email == resource.data.email
        && request.resource.data.collaborationIds is list
        && (!('username' in request.resource.data) || request.resource.data.username is string)
        && (
          !('username' in request.resource.data)
          || request.resource.data.username == resource.data.username
          || usernameClaimedByUserAfter(userId)
        )
        && request.resource.data.get('tier', null) == resource.data.get('tier', null)
        && request.resource.data.get('bonusProjects', 0) == resource.data.get('bonusProjects', 0)
        && request.resource.data.get('projectCount', 0) == resource.data.get('projectCount', 0)
        && request.resource.data.get('isAdmin', false) == resource.data.get('isAdmin', false)
        && request.resource.data.get('suspended', false) == resource.data.get('suspended', false);
    }

    match /users/{userId} {
      allow read: if isAdmin() || isUserSelf(userId);
      allow create: if isUserSelf(userId) && isValidUserCreate(userId);
      allow delete: if isUserSelf(userId);
      allow update: if isAdmin() || (isUserSelf(userId) && isValidUserSelfUpdate(userId));
    }

    // usernames mapping: claim a username if it doesn't exist
    match /usernames/{name} {
      allow read: if true;
      allow create: if isSignedIn()
        && !exists(/databases/$(database)/documents/usernames/$(name))
        && request.resource.data.uid == request.auth.uid
        && exists(/databases/$(database)/documents/users/$(request.auth.uid));
      allow update, delete: if false;
    }

    function validUserCollabCreate(userId) {
      return request.resource.data.keys().hasOnly([
        'userId', 'collaborationId', 'listenedTracks', 'listenedRatio', 'lastInteraction'
      ])
        && request.resource.data.keys().hasAll(['userId', 'collaborationId', 'lastInteraction'])
        && request.resource.data.userId == userId
        && request.resource.data.collaborationId is string
        && request.resource.data.lastInteraction is timestamp
        && (!('listenedTracks' in request.resource.data) || request.resource.data.listenedTracks is list)
        && (!('listenedRatio' in request.resource.data) || request.resource.data.listenedRatio is number);
    }

    function validUserCollabUpdate(userId) {
      return request.resource.data.userId == resource.data.userId
        && request.resource.data.collaborationId == resource.data.collaborationId
        && request.resource.data.get('favoriteTracks', []) == resource.data.get('favoriteTracks', [])
        && request.resource.data.get('finalVote', null) == resource.data.get('finalVote', null)
        && request.resource.data.get('createdAt', null) == resource.data.get('createdAt', null)
        && request.resource.data.get('hasSubmitted', false) == resource.data.get('hasSubmitted', false)
        && request.resource.data.lastInteraction is timestamp
        && (!('listenedTracks' in request.resource.data) || request.resource.data.listenedTracks is list)
        && (!('listenedRatio' in request.resource.data) || request.resource.data.listenedRatio is number)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'listenedTracks', 'listenedRatio', 'lastInteraction'
        ]);
    }

    // userCollaborations: private to the user
    match /userCollaborations/{docId} {
      // reads use resource.data; writes use request.resource.data
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && validUserCollabCreate(request.auth.uid);
      allow update: if isSignedIn() && validUserCollabUpdate(request.auth.uid);
      allow delete: if false;
    }

    match /userDownloads/{downloadId} {
      allow read: if isSignedIn() && (
        downloadId.split('__')[0] == request.auth.uid
        || (resource.data != null && resource.data.userId == request.auth.uid)
      );
      allow create, update: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    // submissionUsers: create by the submitting user; reads restricted (private)
    match /submissionUsers/{docId} {
      allow read, create, update, delete: if false;
    }

    match /submissionUploadTokens/{tokenId} {
      allow read, write: if false;
    }

    // project name index: read, but writes should be via trusted backend (optional)
    match /projectNameIndex/{nameKey} {
      allow read: if true;
      // Name index writes are server-only.
      allow create: if false;
      allow update: if false;
      allow delete: if isSignedIn()
        && resource.data.ownerId == request.auth.uid;
    }

    // tags: read by all, write by admin only
    match /tags/{tagKey} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // reports: create by authenticated users, manage by admin only
    match /reports/{reportId} {
      allow create: if isSignedIn()
        && request.resource.data.reportedBy == request.auth.uid
        && request.resource.data.status == 'pending';
      allow read, update, delete: if isAdmin();
    }

    // resolvedReports: historical record of resolved reports, admin-only
    match /resolvedReports/{resolvedReportId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // feedback: users submit, admins manage
    match /feedback/{feedbackId} {
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.status == 'new'
        && request.resource.data.category is string
        && request.resource.data.message is string
        && request.resource.data.route is string
        && request.resource.data.createdAt is timestamp
        && !('adminNote' in request.resource.data);
      allow read, update, delete: if isAdmin();
    }

    match /adminLogs/{logId} {
      allow read, create: if isAdmin();
      allow update, delete: if false;
    }

    match /systemSettings/{settingId} {
      allow read, write: if isAdmin();
    }
  }
}
