rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isSignedIn() { return request.auth != null; }

    // Public read for audio assets
    // Backing files live at: collabs/{collabId}/backing.{ext}
    // We match any file directly under collab and gate by filename
    match /collabs/{collabId}/{fileName} {
      allow read: if true;
      allow write: if isSignedIn()
        && fileName.matches('^backing\\..+$')
        && request.resource.contentType.matches('audio/.*')
        && request.resource.size < 131072000; // < 125MB
    }

    match /collabs/{collabId}/submissions/{fileId} {
      allow read: if true;
      allow write: if isSignedIn()
        && (
          (request.resource.contentType.matches('audio/.*') && request.resource.size < 131072000)
          || (fileId.matches('^.*-multitracks\\.zip$') && request.resource.size < 314572800)
        );
    }

    match /collabs/{collabId}/docs/{fileName} {
      allow read: if true;
      allow write: if isSignedIn()
        && (
          (fileName.matches('^.*\\.pdf$') && request.resource.size < 52428800)
          || (fileName.matches('^.*\\.zip$') && request.resource.size < 314572800)
        );
    }

    // Optimized/transcoded submission files
    match /collabs/{collabId}/optimized/{fileId} {
      allow read: if true;
      allow write: if isSignedIn() && request.resource.contentType.matches('audio/.*');
    }

    // Default deny
    match /{allPaths=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}

