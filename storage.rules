rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isSignedIn() { return request.auth != null; }
    function tokenDoc(tokenId) {
      return firestore.get(/databases/(default)/documents/submissionUploadTokens/$(tokenId));
    }
    function backingTokenDoc(tokenId) {
      return firestore.get(/databases/(default)/documents/backingUploadTokens/$(tokenId));
    }
    function metaOwnerUid() {
      return request.resource.metadata.ownerUid is string
        ? request.resource.metadata.ownerUid
        : request.resource.metadata.owneruid;
    }
    function metaUploadTokenId() {
      return request.resource.metadata.uploadTokenId is string
        ? request.resource.metadata.uploadTokenId
        : request.resource.metadata.uploadtokenid;
    }
    function metaBackingTokenId() {
      return request.resource.metadata.backingUploadTokenId is string
        ? request.resource.metadata.backingUploadTokenId
        : request.resource.metadata.backinguploadtokenid;
    }
    function metaSubmissionId() {
      return request.resource.metadata.submissionId is string
        ? request.resource.metadata.submissionId
        : request.resource.metadata.submissionid;
    }
    function submissionUserDoc(submissionId) {
      return firestore.get(/databases/(default)/documents/submissionUsers/$(submissionId));
    }
    function collabDoc(collabId) {
      return firestore.get(/databases/(default)/documents/collaborations/$(collabId));
    }
    function projectDoc(projectId) {
      return firestore.get(/databases/(default)/documents/projects/$(projectId));
    }
    function isAdmin() {
      return isSignedIn()
        && firestore.exists(/databases/(default)/documents/users/$(request.auth.uid))
        && firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    function isCollabOwner(collabId) {
      return isSignedIn()
        && firestore.exists(/databases/(default)/documents/collaborations/$(collabId))
        && collabDoc(collabId).data.projectId is string
        && firestore.exists(/databases/(default)/documents/projects/$(collabDoc(collabId).data.projectId))
        && projectDoc(collabDoc(collabId).data.projectId).data.ownerId == request.auth.uid;
    }
    function isCollabParticipant(collabId) {
      return isSignedIn()
        && firestore.exists(/databases/(default)/documents/collaborations/$(collabId))
        && collabDoc(collabId).data.participantIds is list
        && request.auth.uid in collabDoc(collabId).data.participantIds;
    }
    function isValidSubmissionToken(collabId, fileId) {
      return metaUploadTokenId() is string
        && metaOwnerUid() is string
        && request.auth.uid == metaOwnerUid()
        && firestore.exists(/databases/(default)/documents/submissionUploadTokens/$(metaUploadTokenId()))
        && tokenDoc(metaUploadTokenId()).data.collabId == collabId
        && tokenDoc(metaUploadTokenId()).data.uid == request.auth.uid
        && tokenDoc(metaUploadTokenId()).data.used == false
        && tokenDoc(metaUploadTokenId()).data.expiresAt > request.time
        && fileId.matches("^" + tokenDoc(metaUploadTokenId()).data.submissionId + "\\." + tokenDoc(metaUploadTokenId()).data.fileExt + "$");
    }
    function isValidBackingToken(collabId, fileName) {
      return metaBackingTokenId() is string
        && metaOwnerUid() is string
        && request.auth.uid == metaOwnerUid()
        && firestore.exists(/databases/(default)/documents/backingUploadTokens/$(metaBackingTokenId()))
        && backingTokenDoc(metaBackingTokenId()).data.collabId == collabId
        && backingTokenDoc(metaBackingTokenId()).data.uid == request.auth.uid
        && backingTokenDoc(metaBackingTokenId()).data.used == false
        && backingTokenDoc(metaBackingTokenId()).data.expiresAt > request.time
        && fileName.matches("^backing\\." + backingTokenDoc(metaBackingTokenId()).data.fileExt + "$");
    }
    function isValidMultitrackUpload(collabId, fileId) {
      return isValidMultitrackToken(collabId, fileId) || isValidMultitrackOwner(collabId, fileId);
    }
    function isValidMultitrackToken(collabId, fileId) {
      return metaUploadTokenId() is string
        && metaOwnerUid() is string
        && request.auth.uid == metaOwnerUid()
        && firestore.exists(/databases/(default)/documents/submissionUploadTokens/$(metaUploadTokenId()))
        && tokenDoc(metaUploadTokenId()).data.collabId == collabId
        && tokenDoc(metaUploadTokenId()).data.uid == request.auth.uid
        && tokenDoc(metaUploadTokenId()).data.expiresAt > request.time
        && fileId.matches("^" + tokenDoc(metaUploadTokenId()).data.submissionId + "-multitracks\\.zip$");
    }
    function isValidMultitrackOwner(collabId, fileId) {
      return metaSubmissionId() is string
        && metaOwnerUid() is string
        && request.auth.uid == metaOwnerUid()
        && fileId.matches("^" + metaSubmissionId() + "-multitracks\\.zip$")
        && firestore.exists(/databases/(default)/documents/submissionUsers/$(metaSubmissionId()))
        && submissionUserDoc(metaSubmissionId()).data.userId == request.auth.uid
        && submissionUserDoc(metaSubmissionId()).data.collaborationId == collabId;
    }

    // Public read for audio assets
    // Backing files live at: collabs/{collabId}/backing.{ext}
    // We match any file directly under collab and gate by filename
    match /collabs/{collabId}/{fileName} {
      allow read: if true;
      allow write: if isSignedIn()
        && request.resource.contentType.matches('audio/.*')
        && request.resource.size < 131072000 // < 125MB
        && isValidBackingToken(collabId, fileName);
    }

    match /collabs/{collabId}/submissions/{fileId} {
      allow read: if true;
      allow write: if isSignedIn()
        && (
          (request.resource.contentType.matches('audio/.*')
            && request.resource.size < 131072000
            && isValidSubmissionToken(collabId, fileId))
          || (fileId.matches('^.*-multitracks\\.zip$')
            && request.resource.size < 314572800
            && isValidMultitrackUpload(collabId, fileId))
        );
    }

    match /collabs/{collabId}/docs/{fileName} {
      allow read: if isCollabOwner(collabId) || isCollabParticipant(collabId) || isAdmin();
      allow write: if isSignedIn()
        && (
          (fileName.matches('^.*\\.pdf$') && request.resource.size < 52428800)
          || (fileName.matches('^.*\\.zip$') && request.resource.size < 314572800)
        )
        && isCollabOwner(collabId);
    }

    // Optimized/transcoded submission files
    match /collabs/{collabId}/optimized/{fileId} {
      allow read: if true;
      allow write: if false;
    }

    // Default deny
    match /{allPaths=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}
